<!DOCTYPE html>
<html>
<head>
  <title>Scan QR (Admin)</title>
  <meta charset="UTF-8" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; text-align: center; }
    #result, #error { margin-top: 2rem; font-size: 1.2rem; }
    #error { color: red; }
  </style>
</head>
<body>
  <h1>กำลังสแกน QR Code...</h1>
  <div id="result"></div>
  <div id="error"></div>

  <script>
    const LIFF_ID = '2007226288-Qj0NDKY0'; // ใส่ LIFF ID ของคุณ
    const SCAN_INTERVAL = 3000; // 3 วินาที

    let isScanning = true; // ตัวแปรเพื่อควบคุมการสแกน

    async function startScan() {
      try {
        if (!liff.isLoggedIn()) await liff.login();
        const profile = await liff.getProfile();
        const adminId = profile.userId;

        if (isScanning) {
          const scanResult = await liff.scanCode();
          const token = scanResult.value;

          document.getElementById('result').textContent = '✅ ตรวจสอบข้อมูล...';
          document.getElementById('error').textContent = '';

          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ mode: 'scan', adminId, token }),
            headers: { 'Content-Type': 'application/json' },
          });

          const data = await res.json();
          if (data.status === 'success') {
            document.getElementById('result').textContent = `✅ ${data.message}`;
            document.getElementById('error').textContent = '';
          } else {
            document.getElementById('result').textContent = '';
            document.getElementById('error').textContent = `❌ ${data.message}`;
          }
        }

      } catch (err) {
        document.getElementById('error').textContent = '❌ ' + err.message;
        document.getElementById('result').textContent = '';
      }

      // รอ 3 วินาที แล้วเริ่มสแกนใหม่
      setTimeout(() => {
        document.getElementById('result').textContent = '';
        document.getElementById('error').textContent = '';
        isScanning = true; // เปิดให้สามารถสแกนใหม่ได้
        startScan();
      }, SCAN_INTERVAL);
    }

    window.onload = () => {
      liff.init({ liffId: LIFF_ID })
        .then(() => startScan())
        .catch(err => {
          document.getElementById('error').textContent = 'LIFF Init Error: ' + err.message;
        });
    };
  </script>
</body>
</html>
