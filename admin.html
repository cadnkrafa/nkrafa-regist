<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: #f4f7fa;
      padding: 20px;
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .reset-btn {
      position: absolute;
      top: 20px;
      right: 110px;
    }
    table td, table th {
      vertical-align: middle;
      font-size: 0.95em;
    }
    th:nth-child(1) { width: 110px; }
    th:nth-child(2) { width: 80px; }
    th:nth-child(3) { width: 160px; }
    th:nth-child(4) { width: 160px; }
    th:nth-child(5), th:nth-child(6) { width: 100px; text-align: center; }
  </style>
</head>
<body>
  <button class="btn btn-warning reset-btn" onclick="resetRoles()">Reset ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
  <button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

  <div class="container">
    <h2 class="text-center mb-4">üéñÔ∏è Super Admin Panel</h2>

    <div class="row mb-3">
      <div class="col-md-3">
        <input id="searchInput" type="text" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
      </div>
      <div class="col-md-2">
        <select id="unitFilter" class="form-select">
          <option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-primary">
          <tr>
            <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
            <th>‡∏¢‡∏®</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th>Admin</th>
            <th>SuperAdmin</th>
          </tr>
        </thead>
        <tbody id="adminTable"></tbody>
      </table>
    </div>
  </div>

<script>
let personnelData = [];

async function initLiffAndCheckAdmin() {
  await liff.init({ liffId: LIFF_ID_ADMIN });
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
    return;
  }
  const profile = await liff.getProfile();
  const userId = profile.userId;
  const res = await fetch(`${SCRIPT_URL}?checkAdmin=true&userId=${userId}`);
  const isAdmin = await res.text();

  if (isAdmin !== 'true') {
    document.body.innerHTML = '<h2 style="text-align:center; color:red; padding:50px;">‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>';
    return;
  }

  loadPersonnelData(); // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
}

async function loadPersonnelData() {
  const res = await fetch(`${SCRIPT_URL}?getPersonnel=1`);
  const data = await res.json();
  personnelData = data;
  renderPersonnelTable(data);
}

function renderPersonnelTable(data) {
  const tbody = document.getElementById('data-table-body');
  tbody.innerHTML = '';

  const search = document.getElementById('searchInput').value.toLowerCase();
  const unitFilter = document.getElementById('unitFilter').value;
  const units = [...new Set(data.map(row => row.unit))];
  document.getElementById('unitFilter').innerHTML = '<option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');
  document.getElementById('unitFilter').value = unitFilter;

  data.filter(row =>
    (!unitFilter || row.unit === unitFilter) &&
    (row.name.toLowerCase().includes(search) || row.rtafId.includes(search))
  ).forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.rtafId}</td>
      <td>${row.rank}</td>
      <td>${row.name}</td>
      <td>${row.position}</td>
      <td>${row.unit}</td>
      <td>
        <button class="btn btn-sm btn-primary"><i data-lucide="edit"></i></button>
        <button class="btn btn-sm btn-danger"><i data-lucide="trash-2"></i></button>
      </td>
      <td>${row.linked ? '‚úÖ' : ''}</td>
      <td class="checkbox-cell">
        <input type="checkbox" ${row.list ? 'checked' : ''} onchange="updateCheckbox('${row.rtafId}', 'list', this.checked)">
      </td>
      <td class="checkbox-cell">
        <input type="checkbox" ${row.drawer ? 'checked' : ''} onchange="updateCheckbox('${row.rtafId}', 'drawer', this.checked)">
      </td>
    `;
    tbody.appendChild(tr);
  });
  lucide.createIcons();
}

function updateCheckbox(rtafId, field, value) {
  fetch(`${SCRIPT_URL}?updateRole=1&rtafId=${rtafId}&role=${field}&value=${value}`)
    .then(res => res.text())
    .then(txt => console.log('‚úÖ updated', rtafId, field, value))
    .catch(err => console.error('‚ùå error:', err));
}

document.getElementById('searchInput').addEventListener('input', () => renderPersonnelTable(personnelData));
document.getElementById('unitFilter').addEventListener('change', () => renderPersonnelTable(personnelData));

document.addEventListener('DOMContentLoaded', initLiffAndCheckAdmin);
</script>
  
</body>
</html>
