<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <style>
    body { font-family: 'Noto Sans Thai', sans-serif; margin: 0; background: #f4f6f8; }
    header { background: #3498db; padding: 12px 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .btn { padding: 8px 14px; border-radius: 5px; font-size: 14px; display: flex; align-items: center; gap: 6px; border: none; color: white; cursor: pointer; }
    .btn-reset { background: #f39c12; } .btn-logout { background: #e74c3c; }
    .tab-bar { display: flex; gap: 10px; background: #f2f2f2; padding: 0 20px; }
    .tab { padding: 10px 16px; border: 1px solid #ccc; border-bottom: none; background: white; cursor: pointer; font-weight: bold; }
    .tab.active { border-bottom: 2px solid #3498db; color: #3498db; }
    .tab-content { padding: 0 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 15px; }
    th { background: #dceeff; font-weight: bold; }
    .top-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding-top: 16px; }
    .filters { display: flex; gap: 10px; }
    .filters input, .filters select { padding: 8px 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; font-family: 'Noto Sans Thai', sans-serif; }
  </style>
</head>
<body>
  <header>
    <h1><i data-lucide="settings"></i> Admin Panel</h1>
    <div>
      <button class="btn btn-reset" onclick="resetSheet('tokens')"><i data-lucide="rotate-ccw"></i> Reset Tokens</button>
      <button class="btn btn-reset" onclick="resetSheet('regist')"><i data-lucide="rotate-ccw"></i> Reset Regist</button>
      <button class="btn btn-reset" onclick="resetSheet('drawprize')"><i data-lucide="rotate-ccw"></i> Reset ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
      <button class="btn btn-logout" onclick="logout()"><i data-lucide="log-out"></i> Logout</button>
    </div>
  </header>
  <div class="tab-bar">
    <div class="tab active" onclick="showTab('personnel-tab')">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</div>
  </div>
  <div class="tab-content" id="personnel-tab">
    <div class="top-controls">
      <div class="filters">
        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
        <select id="unitFilter"></select>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
          <th>‡∏¢‡∏®</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
          <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏•‡∏ô‡πå</th>
          <th>
            ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô<br>
            <input type="checkbox" id="listAllCheckbox" onchange="toggleAllList(this.checked)">
          </th>
          <th>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
        </tr>
      </thead>
      <tbody id="data-table-body"></tbody>
    </table>
  </div>
<script>

let allPersonnelData = [];
let linkData = [];

function initLiffAdmin() {
  liff.init({ liffId: LIFF_ID_ADMIN }).then(() => {
    if (!liff.isLoggedIn()) return liff.login();
    liff.getProfile().then(profile => {
      const userId = profile.userId;
      fetch(`${SCRIPT_URL}?checkAdmin=true&userId=${userId}`)
        .then(res => res.text())
        .then(isAdmin => {
          if (isAdmin === 'true') {
            loadAllData();
          } else {
            document.body.innerHTML = '<h1 style="text-align:center;color:red;padding:50px;">‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>';
          }
        });
    });
  });
}

function loadAllData() {
  loadSheet('data', handlePersonnelData);
  loadSheet('link', data => linkData = data);
  loadSheet('rank', handleRankData);
  loadSheet('unit', handleUnitData);
}

function loadSheet(sheetName, callback) {
  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?adminPage=true&type=${sheetName}&action=get&callback=${callback.name}`;
  document.body.appendChild(script);
}

function handlePersonnelData(data) {
  allPersonnelData = data;
  renderPersonnelTable();
  populateUnitFilter();
}

function handleRankData(data) {
  // handle rank if needed
}

function handleUnitData(data) {
  const select = document.getElementById('unitFilter');
  select.innerHTML = '<option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>';
  const sorted = data.filter(r => r[1]).sort((a, b) => a[0] - b[0]);
  sorted.forEach(r => {
    const opt = document.createElement('option');
    opt.value = opt.text = r[1];
    select.appendChild(opt);
  });
}

function renderPersonnelTable() {
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  const unit = document.getElementById('unitFilter').value;
  const tbody = document.getElementById('data-table-body');
  tbody.innerHTML = '';

  allPersonnelData.forEach((row, i) => {
    const [rtafId, rank, name, position, unitName, list, , drawer] = row;
    const matchKeyword = `${rtafId}${rank}${name}${position}${unitName}`.toLowerCase().includes(keyword);
    const matchUnit = !unit || unit === unitName;
    if (!(matchKeyword && matchUnit)) return;

    const isLinked = linkData.some(link => link[1] === rtafId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${rtafId}</td>
      <td>${rank}</td>
      <td>${name}</td>
      <td>${position}</td>
      <td>${unitName}</td>
      <td>
        <button onclick="editRow(${i})">‚úèÔ∏è</button>
        <button onclick="deleteRow(${i})">üóëÔ∏è</button>
      </td>
      <td>${isLinked ? '‚úÖ' : ''}</td>
      <td class="checkbox-cell">
        <input type="checkbox" data-index="${i}" onchange="toggleList(this)" ${list === 'TRUE' ? 'checked' : ''}>
      </td>
      <td class="checkbox-cell">
        <input type="checkbox" onchange="toggleDrawer(${i}, this.checked)" ${drawer === true || drawer === 'TRUE' ? 'checked' : ''}>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function toggleDrawer(index, value) {
  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?adminPage=true&type=data&action=update&index=${index}&drawer=${value}&callback=renderPersonnelTable`;
  document.body.appendChild(script);
}

function toggleList(checkbox) {
  const index = checkbox.dataset.index;
  const value = checkbox.checked ? 'TRUE' : '';
  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?adminPage=true&type=data&action=update&index=${index}&list=${value}&callback=renderPersonnelTable`;
  document.body.appendChild(script);
}

function toggleAllList(checkbox) {
  const checkboxes = document.querySelectorAll('input[data-index]');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  checkboxes.forEach(cb => toggleList(cb));
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('searchInput').addEventListener('input', renderPersonnelTable);
  document.getElementById('unitFilter').addEventListener('change', renderPersonnelTable);
});

</script>
</body>
</html>
