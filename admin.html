<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    header {
      background: #3498db;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    header h1 {
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }
    .tab-bar {
      background: #f2f2f2;
      display: flex;
      padding: 0 20px;
      gap: 10px;
    }
    .tab {
      padding: 10px 16px;
      background: white;
      border: 1px solid #ccc;
      border-bottom: none;
      cursor: pointer;
      font-weight: bold;
    }
    .tab.active {
      background: #fff;
      border-bottom: 2px solid #3498db;
      color: #3498db;
    }
    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px 0;
      flex-wrap: wrap;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-grow: 1;
      max-width: 30%;
    }
    .filters input[type="text"], .filters select {
      font-family: 'Noto Sans Thai', sans-serif;
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .btn {
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 5px;
      color: white;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .btn-reset { background: #f39c12; }
    .btn-logout { background: #e74c3c; }
    .btn-add { background: #2ecc71; white-space: nowrap; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 15px;
    }
    th {
      background: #dceeff;
      font-weight: bold;
    }
    .tab-content { padding: 0 20px; }
    .hidden { display: none; }
    .checkbox-cell input { transform: scale(1.2); }
  </style>
</head>
<body>
  <header>
    <h1><i data-lucide="settings"></i> Admin Panel</h1>
    <div id="overlay" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.2);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  color: #000;
  font-family: 'Noto Sans Thai', sans-serif;
  font-weight: bold;
">
  ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
</div>
    <div class="action-buttons">
      <button class="btn btn-reset" onclick="resetSheet('tokens')"><i data-lucide="rotate-ccw"></i> Reset Tokens</button>
      <button class="btn btn-reset" onclick="resetSheet('regist')"><i data-lucide="rotate-ccw"></i> Reset Regist</button>
      <button class="btn btn-reset" onclick="resetSheet('drawprize')"><i data-lucide="rotate-ccw"></i> Reset ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
      <button class="btn btn-logout" onclick="logout()"><i data-lucide="log-out"></i> Logout</button>
    </div>
  </header>

  <div class="tab-bar">
    <div class="tab active" onclick="showTab('personnel-tab')">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</div>
    <div class="tab" onclick="showTab('rank-tab')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®</div>
    <div class="tab" onclick="showTab('unit-tab')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
  </div>

  <div class="tab-content" id="personnel-tab">
    <div class="top-controls">
      <div class="filters">
        <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
        <select id="unitFilter"></select>
      </div>
      <button class="btn btn-add" onclick="addNewRow()"><i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:10%">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
          <th style="width:8%">‡∏¢‡∏®</th>
          <th style="width:20%">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th style="width:20%">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
          <th style="width:10%">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th style="width:10%">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö</th>
          <th style="width:8%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏•‡∏ô‡πå</th>
          <th style="width:8%">‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô <input type="checkbox" id="checkAllList" onchange="toggleAllList(this)">
          </th>
          <th style="width:8%">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
        </tr>
      </thead>
      <tbody id="data-table-body"></tbody>
    </table>
  </div>

  <div class="tab-content hidden" id="rank-tab"></div>
  <div class="tab-content hidden" id="unit-tab"></div>

<script>
let personnelData = [];
let unitList = [];
let rankList = [];
let visibleRows = [];

async function initLiffAndCheckAdmin() {
  await liff.init({ liffId: LIFF_ID_ADMIN });
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
    return;
  }
  const profile = await liff.getProfile();
  const userId = profile.userId;
  const res = await fetch(`${SCRIPT_URL}?checkAdmin=true&userId=${userId}`);
  const isAdmin = await res.text();

  if (isAdmin !== 'true') {
    document.body.innerHTML = '<h2 style="text-align:center; color:red; padding:50px;">‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>';
    return;
  }

  await loadUnitList();
  await loadRankList();
  loadPersonnelData();
}

function logout() {
  if (liff.isLoggedIn()) {
    liff.logout();
    location.reload();
  }
}

async function loadUnitList() {
  const res = await fetch(`${SCRIPT_URL}?getUnitList=1`);
  const list = await res.json();
  unitList = list.map(row => row[1]);
}

async function loadRankList() {
  const res = await fetch(`${SCRIPT_URL}?getRankList=1`);
  const list = await res.json();
  rankList = list.map(row => row[1]); // column 2 = ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏®
}

async function loadPersonnelData() {
  const res = await fetch(`${SCRIPT_URL}?getPersonnel=1`);
  const data = await res.json();
  personnelData = data;
  renderPersonnelTable(data);
}

function addNewRow() {
  const tbody = document.getElementById('data-table-body');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" id="new-rtafId" style="width: 100%"></td>
    <td>
      <select id="new-rank" style="width: 100%">
        ${rankList.map(rank => `<option value="${rank}">${rank}</option>`).join('')}
      </select>
    </td>
    <td><input type="text" id="new-name" style="width: 100%"></td>
    <td><input type="text" id="new-position" style="width: 100%"></td>
    <td>
      <select id="new-unit" style="width: 100%">
        ${unitList.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
      </select>
    </td>
    <td colspan="4">
        <div class="flex items-center gap-2">
          <button onclick="submitNewRow()" class="px-2 py-1 text-white bg-yellow-500 hover:bg-yellow-600 rounded" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">
            <i data-lucide="save"></i>
          </button>
          <button onclick="renderPersonnelTable(personnelData)" class="px-2 py-1 text-white bg-red-500 hover:bg-red-600 rounded" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">
            <i data-lucide="x"></i>
          </button>
        </div>
    </td>
  `;
  tbody.prepend(tr);
  lucide.createIcons();
}

function submitNewRow() {
  const newData = {
    rtafId: document.getElementById('new-rtafId').value.trim(),
    rank: document.getElementById('new-rank').value.trim(),
    name: document.getElementById('new-name').value.trim(),
    position: document.getElementById('new-position').value.trim(),
    unit: document.getElementById('new-unit').value.trim()
  };

  if (!newData.rtafId || !newData.rank || !newData.name || !newData.position || !newData.unit) {
    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    return;
  }

  fetch(`${SCRIPT_URL}?addPersonnel=true`, {
    method: 'POST',
    body: JSON.stringify(newData),
    headers: { 'Content-Type': 'application/json' }
  })
    .then(res => res.text())
    .then(txt => {
      if (txt.includes("success")) {
        alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        loadPersonnelData();
      } else if (txt.includes("duplicate")) {
        alert("‚ö†Ô∏è ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
      } else {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
      }
    })
    .catch(err => {
      console.error("‚ùå Add error:", err);
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    });
}

function renderPersonnelTable(data) {
  const tbody = document.getElementById('data-table-body');
  tbody.innerHTML = '';

  const search = document.getElementById('searchInput').value.toLowerCase();
  const unitFilter = document.getElementById('unitFilter').value;
  const units = unitList.length ? unitList : [...new Set(data.map(row => row.unit))].sort();
  document.getElementById('unitFilter').innerHTML = '<option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');
  document.getElementById('unitFilter').value = unitFilter;

  visibleRows = data.filter(row =>
    (!unitFilter || row.unit === unitFilter) &&
    (row.name.toLowerCase().includes(search) || row.rtafId.includes(search))
  );

  visibleRows.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.rtafId}</td>
      <td>${row.rank}</td>
      <td>${row.name}</td>
      <td>${row.position}</td>
      <td>${row.unit}</td>
      <td>
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 text-white bg-yellow-500 hover:bg-yellow-600 rounded" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
            <i data-lucide="edit"></i>
          </button>
          <button class="px-2 py-1 text-white bg-red-500 hover:bg-red-600 rounded" title="‡∏•‡∏ö">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      </td>
      <td>${row.linked ? '‚úÖ' : ''}</td>
      <td class="checkbox-cell text-center">
        <input type="checkbox" ${row.list ? 'checked' : ''} data-field="list" data-rtafId="${row.rtafId}"
          onchange="updateCheckbox('${row.rtafId}', 'list', this.checked)">
      </td>
      <td class="checkbox-cell text-center">
        <input type="checkbox" ${row.drawer ? 'checked' : ''}
          onchange="updateCheckbox('${row.rtafId}', 'drawer', this.checked)">
      </td>
    `;
    tbody.appendChild(tr);
  });

  const allChecked = visibleRows.every(row => row.list === true);
  const master = document.getElementById('checkAllList');
  if (master) master.checked = allChecked;

  lucide.createIcons();
}

function updateCheckbox(rtafId, field, value) {
  fetch(`${SCRIPT_URL}?updateRole=1&rtafId=${rtafId}&role=${field}&value=${value}`)
    .then(res => res.text())
    .then(txt => {
      console.log('‚úÖ updated', rtafId, field, value);
      const person = personnelData.find(p => p.rtafId === rtafId);
      if (person) person[field] = value;

      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ master checkbox ‡πÉ‡∏´‡∏°‡πà
      if (field === 'list') updateCheckAllListStatus();
    })
    .catch(err => console.error('‚ùå error:', err));
}

function updateCheckAllListStatus() {
  const master = document.getElementById('checkAllList');
  const allChecked = visibleRows.every(row => row.list === true);
  master.checked = allChecked;
}


async function toggleAllList(masterCheckbox) {
  const checked = masterCheckbox.checked;
  const overlay = document.getElementById('overlay');
  overlay.style.display = 'flex';

  masterCheckbox.disabled = true;
  const checkboxes = document.querySelectorAll('#data-table-body input[type="checkbox\"][data-field="list\"]');
  checkboxes.forEach(cb => cb.disabled = true);

  for (const row of visibleRows) {
    const rtafId = row.rtafId;
    if (row.list !== checked) {
      row.list = checked;

      const checkbox = document.querySelector(`#data-table-body input[data-rtafId=\"${rtafId}\"]`);
      if (checkbox) checkbox.checked = checked;

      try {
        const res = await fetch(`${SCRIPT_URL}?updateRole=1&rtafId=${rtafId}&role=list&value=${checked}`);
        const text = await res.text();
        console.log(`‚úÖ ${rtafId}: ${text}`);
      } catch (err) {
        console.warn(`‚ùå ${rtafId}:`, err);
      }
    }
  }

  checkboxes.forEach(cb => cb.disabled = false);
  masterCheckbox.disabled = false;
  overlay.style.display = 'none';

  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

function fetchWithTimeout(resource, options = {}) {
  const { timeout = 8000 } = options;
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);

  return fetch(resource, {
    ...options,
    signal: controller.signal
  }).finally(() => clearTimeout(id));
}

document.getElementById('searchInput').addEventListener('input', () => renderPersonnelTable(personnelData));
document.getElementById('unitFilter').addEventListener('change', () => renderPersonnelTable(personnelData));
document.addEventListener('DOMContentLoaded', initLiffAndCheckAdmin);
</script>

</body>
</html>
