<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: #f4f7fa;
      padding: 20px;
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    table td, table th {
      vertical-align: middle;
      font-size: 0.95em;
    }
    th:nth-child(1) { width: 110px; }  /* RTAF_ID */
    th:nth-child(2) { width: 80px; }   /* Rank */
    th:nth-child(3) { width: 160px; }  /* Name */
    th:nth-child(4) { width: 160px; }  /* Unit */
    th:nth-child(5), th:nth-child(6) { width: 100px; text-align: center; } /* Admin, SuperAdmin */
  </style>
</head>
<body>
  <button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

  <div class="container">
    <h2 class="text-center mb-4">üéñÔ∏è Super Admin Panel</h2>

    <div class="row mb-3">
      <div class="col-md-6">
        <input id="searchInput" type="text" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠">
      </div>
      <div class="col-md-4">
        <select id="unitFilter" class="form-select">
          <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ --</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-primary">
          <tr>
            <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
            <th>‡∏¢‡∏®</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th>Admin</th>
            <th>SuperAdmin</th>
          </tr>
        </thead>
        <tbody id="adminTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    async function getUserId() {
      await liff.init({ liffId: LIFF_ID_SUPERADMIN });
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
        return;
      }
      const profile = await liff.getProfile();
      return profile.userId;
    }

    async function main() {
      const userId = await getUserId();
      const check = await fetch(`${SCRIPT_URL}?checkSuperAdmin=1&userId=${encodeURIComponent(userId)}`);
      const isSuper = await check.text();
      if (isSuper !== 'true') {
        alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
        document.body.innerHTML = '<h3 class="text-center text-danger mt-5">‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h3>';
        return;
      }
      loadAdminList();
    }

    async function loadAdminList() {
      const res = await fetch(`${SCRIPT_URL}?getAdminList=1`);
      const list = await res.json();
      renderTable(list);
    }

    function renderTable(data) {
      const table = document.getElementById('adminTable');
      table.innerHTML = '';

      const units = [...new Set(data.map(row => row.unit))];
      const unitFilter = document.getElementById('unitFilter');
      unitFilter.innerHTML = '<option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ --</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');

      const filterAndRender = () => {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const unit = unitFilter.value;
        const filtered = data.filter(row =>
          (!unit || row.unit === unit) &&
          (row.name.toLowerCase().includes(search) || row.rtafId.includes(search))
        );
        table.innerHTML = filtered.map(row => `
          <tr>
            <td>${row.rtafId}</td>
            <td>${row.rank}</td>
            <td>${row.name}</td>
            <td>${row.unit}</td>
            <td class="text-center">
              <input type="checkbox" ${row.admin ? 'checked' : ''} onchange="updateRole('${row.rtafId}', 'admin', this.checked)">
            </td>
            <td class="text-center">
              <input type="checkbox" ${row.superadmin ? 'checked' : ''} onchange="updateRole('${row.rtafId}', 'superadmin', this.checked)">
            </td>
          </tr>
        `).join('');
      };

      document.getElementById('searchInput').oninput = filterAndRender;
      document.getElementById('unitFilter').onchange = filterAndRender;
      filterAndRender();
    }

    function updateRole(rtafId, field, value) {
      fetch(`${SCRIPT_URL}?updateRole=1&rtafId=${rtafId}&role=${field}&value=${value}`)
        .then(res => res.text())
        .then(msg => console.log(msg))
        .catch(err => console.error('Error:', err));
    }

    function logout() {
      if (liff.isLoggedIn()) liff.logout();
      location.reload();
    }

    main();
  </script>
</body>
</html>

