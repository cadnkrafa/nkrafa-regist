<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: #f4f7fa;
      padding: 20px;
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .reset-btn {
      position: absolute;
      top: 20px;
      right: 110px;
    }
    table td, table th {
      text-align: center;
      vertical-align: middle;
      font-size: 0.95em;
    }
    th:nth-child(1) { width: 110px; }
    th:nth-child(2) { width: 80px; }
    th:nth-child(3) { width: 160px; }
    th:nth-child(4) { width: 160px; }
    th:nth-child(5), th:nth-child(6) { width: 100px; text-align: center; }
  </style>
</head>
<body>
  <button class="btn btn-warning reset-btn" onclick="resetRoles()">Reset ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
  <button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

  <div class="container">
    <h2 class="text-center mb-4">üéñÔ∏è Super Admin Panel</h2>

    <div class="row mb-3">
      <div class="col-md-3">
        <input id="searchInput" type="text" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
      </div>
      <div class="col-md-2">
        <select id="unitFilter" class="form-select">
          <option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-primary">
          <tr>
            <th style="width:12%">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
            <th style="width:12%">‡∏¢‡∏®</th>
            <th style="width:41%">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th style="width:15%">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th style="width:10%">Admin</th>
            <th style="width:10%">SuperAdmin</th>
          </tr>
        </thead>
        <tbody id="adminTable"></tbody>
      </table>
    </div>
  </div>

  <script>
let currentData = [];
let unitList = [];

async function getUserId() {
  await liff.init({ liffId: LIFF_ID_SUPERADMIN });
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
    return;
  }
  const profile = await liff.getProfile();
  return profile.userId;
}

async function main() {
  const userId = await getUserId();
  const check = await fetch(`${SCRIPT_URL}?checkSuperAdmin=1&userId=${encodeURIComponent(userId)}`);
  const isSuper = await check.text();
  if (isSuper !== 'true') {
    alert('‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    document.body.innerHTML = '<h3 class="text-center text-danger mt-5">‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>';
    return;
  }
  await loadUnitList();
  loadAdminList();
}

async function loadUnitList() {
  const res = await fetch(`${SCRIPT_URL}?getUnitList=1`);
  const list = await res.json();
  unitList = list.map(row => row[1]);
}

async function loadAdminList() {
  const res = await fetch(`${SCRIPT_URL}?getAdminList=1`);
  const list = await res.json();
  currentData = list;
  renderTable(currentData);
}

function renderTable(data) {
  const table = document.getElementById('adminTable');
  table.innerHTML = '';

  const unitFilter = document.getElementById('unitFilter');
  const selectedUnit = unitFilter.value;

  const units = unitList.length ? unitList : [...new Set(data.map(row => row.unit))];
  unitFilter.innerHTML = '<option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');
  unitFilter.value = selectedUnit;

  const filterAndRender = () => {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const unit = unitFilter.value;
    const filtered = data.filter(row =>
      (!unit || row.unit === unit) &&
      (row.name.toLowerCase().includes(search) || row.rtafId.includes(search))
    );
    table.innerHTML = filtered.map(row => `
      <tr>
        <td>${row.rtafId}</td>
        <td>${row.rank}</td>
        <td>${row.name}</td>
        <td>${row.unit}</td>
        <td class="text-center">
          <input type="checkbox" ${row.admin === true ? 'checked' : ''} onchange="updateRole('${row.rtafId}', 'admin', this.checked)">
        </td>
        <td class="text-center">
          <input type="checkbox" ${row.superadmin === true ? 'checked' : ''} onchange="updateRole('${row.rtafId}', 'superadmin', this.checked)">
        </td>
      </tr>
    `).join('');
  };

  document.getElementById('searchInput').oninput = filterAndRender;
  document.getElementById('unitFilter').onchange = filterAndRender;
  filterAndRender();

  const headers = document.querySelectorAll("th");
  headers.forEach((th, index) => {
    th.style.cursor = "pointer";
    th.onclick = () => {
      const rows = Array.from(table.querySelectorAll("tr"));
      const getText = row => row.children[index].textContent.trim().toLowerCase();
      const isBool = index >= 4;
      rows.sort((a, b) => {
        let valA = getText(a), valB = getText(b);
        if (isBool) {
          valA = valA === 'true';
          valB = valB === 'true';
        }
        return (valA > valB ? 1 : valA < valB ? -1 : 0) * (sortState.asc ? 1 : -1);
      });
      sortState.asc = sortState.column === index ? !sortState.asc : true;
      sortState.column = index;
      rows.forEach(row => table.appendChild(row));
    };
  });
}

function updateRole(rtafId, field, value) {
  fetch(`${SCRIPT_URL}?updateRole=1&rtafId=${rtafId}&role=${field}&value=${value}`)
    .then(res => res.text())
    .then(msg => {
      console.log("üìù updated:", msg);
      const target = currentData.find(row => row.rtafId === rtafId);
      if (target) target[field] = value === true || value === 'true';
      renderTable(currentData);
    })
    .catch(err => console.error('Error:', err));
}

async function resetRoles() {
  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
  try {
    const res = await fetch(`${SCRIPT_URL}?resetRoles=1`);
    const msg = await res.text();
    console.log("üîÅ resetRoles:", msg);
    alert("‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    await new Promise(resolve => setTimeout(resolve, 500));
    loadAdminList();
  } catch (err) {
    console.error("‚ùå resetRoles error:", err);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï");
  }
}

function logout() {
  if (liff.isLoggedIn()) liff.logout();
  location.reload();
}

let sortState = { column: null, asc: true };
main();
</script>

</body>
</html>

