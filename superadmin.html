<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans Thai', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 20px;
    }
    #status {
      font-size: 1.8em;
      color: red;
      text-align: center;
      margin-top: 100px;
    }
    #panel {
      display: none;
    }
    select {
      font-size: 1em;
      padding: 5px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 0.95em;
    }
    th {
      background-color: #e0f0ff;
    }
    .small {
      width: 80px;
    }
    .medium {
      width: 120px;
    }
  </style>
</head>
<body>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</div>
  <div id="panel">
    <h2>üéñÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Super Admin</h2>
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢: 
      <select id="unitFilter">
        <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ --</option>
      </select>
    </label>
    <table id="adminTable">
      <thead>
        <tr>
          <th class="small">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
          <th class="small">‡∏¢‡∏®</th>
          <th class="medium">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="medium">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th class="small">Admin</th>
          <th class="small">SuperAdmin</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="liff.logout(); location.reload();">Logout</button>
  </div>

  <script>
    let fullData = [];

    async function getUserId() {
      await liff.init({ liffId: LIFF_ID_SUPERADMIN });
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: location.href });
        return null;
      }
      const profile = await liff.getProfile();
      return profile.userId;
    }

    async function main() {
      const userId = await getUserId();
      if (!userId) return;
      const res = await fetch(`${SCRIPT_URL}?checkSuperAdmin=1&userId=${userId}`);
      const isSuper = await res.text();

      if (isSuper !== 'true') {
        document.getElementById("status").innerText = "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ";
        return;
      }

      document.getElementById("status").style.display = "none";
      document.getElementById("panel").style.display = "block";

      const listRes = await fetch(`${SCRIPT_URL}?getAdminList=1`);
      fullData = await listRes.json();

      populateUnitFilter();
      renderTable();
    }

    function populateUnitFilter() {
      const unitSet = new Set(fullData.map(u => u.unit));
      const select = document.getElementById("unitFilter");
      Array.from(unitSet).sort().forEach(unit => {
        const opt = document.createElement("option");
        opt.value = unit;
        opt.innerText = unit;
        select.appendChild(opt);
      });
      select.onchange = renderTable;
    }

    function renderTable() {
      const unit = document.getElementById("unitFilter").value;
      const tbody = document.getElementById("adminTable").querySelector("tbody");
      tbody.innerHTML = '';

      fullData.filter(r => !unit || r.unit === unit).forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.rtafId}</td>
          <td>${row.rank}</td>
          <td>${row.name}</td>
          <td>${row.unit}</td>
          <td><input type="checkbox" ${row.admin ? 'checked' : ''} onchange="updateRole('${row.rtafId}', 'admin', this.checked)"></td>
          <td><input type="checkbox" ${row.superadmin ? 'checked' : ''} onchange="updateRole('${row.rtafId}', 'superadmin', this.checked)"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateRole(rtafId, field, value) {
      fetch(`${SCRIPT_URL}?updateRole=1&rtafId=${rtafId}&field=${field}&value=${value}`);
    }

    main();
  </script>
</body>
</html>
