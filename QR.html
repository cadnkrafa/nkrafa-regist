<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Registration</title>
  <style>
    .qr-container {
      text-align: center;
      margin-top: 20px;
    }
    .qr-code {
      width: 250px;
      height: 250px;
    }
    .error {
      color: red;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">ลงทะเบียนข้าราชการ</h1>
  <div class="qr-container">
    <img id="qrCodeImage" class="qr-code" src="" alt="QR Code จะปรากฏที่นี่">
    <div id="errorMessage" class="error"></div>
  </div>

  <script>
    // ฟังก์ชันดึงค่าจาก query string
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const userId = getQueryParam("userId");

    if (userId) {
      fetchQRCode(userId);
    } else {
      document.getElementById("errorMessage").innerText = "ไม่พบ userId ใน URL";
    }

    function fetchQRCode(userId) {
      const scriptUrl = `https://script.google.com/macros/s/AKfycbxT4YBr2MBhoTZc0ogk1FCmnHy2HGkDuyw-fTv7roVQrD1zlDNAU0nhNtbwBdMPrG4Ckg/exec?userId=${encodeURIComponent(userId)}`;

      fetch(scriptUrl)
        .then(response => response.json())
        .then(data => {
          if (data.qrCodeUrl) {
            document.getElementById("qrCodeImage").src = data.qrCodeUrl;
          } else {
            document.getElementById("errorMessage").innerText = "ไม่สามารถดึง QR Code ได้";
          }
        })
        .catch(error => {
          console.error("Error fetching QR Code: ", error);
          document.getElementById("errorMessage").innerText = "เกิดข้อผิดพลาดในการเชื่อมต่อ";
        });
    }

    // รีเฟรช QR Code ทุก 10 วินาที
    setInterval(() => {
      if (userId) {
        fetchQRCode(userId);
      }
    }, 10000); // 10,000 ms = 10 วินาที
  </script>
</body>
</html>
