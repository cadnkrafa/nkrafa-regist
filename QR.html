<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Registration</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #f4f7fc;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            text-align: center;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-top: 0;
            padding-top: 30px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô */
        }

        .qr-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
        }

        .qr-code {
            width: 100%;
            max-width: 250px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .countdown {
            font-size: 1.2em;
            color: #333;
            margin-top: 10px;
            font-weight: 500;
        }

        .error {
            color: red;
            margin-top: 20px;
            font-weight: 600;
        }

        .qr-container .loading {
            font-size: 1.2em;
            color: #ff6600;
            font-weight: bold;
        }

        .qr-container .title {
            color: #0073e6;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .countdown {
            color: #ff4d4d;
        }

        .registered {
            color: green;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="qr-container">
        <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h1>
        <div class="title">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
        <img id="qrCodeImage" class="qr-code" src="" alt="QR Code ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
        <div id="countdown" class="countdown"></div>
        <div id="errorMessage" class="error"></div>
        <div id="loadingMessage" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div id="registeredMessage" class="registered" style="display: none;">‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="config.js"></script>
    <script>
        const liffId = "2007226288-k77xbmX7"; // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        let userId = null;
        let countdownSeconds = 20;  // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        let countdownInterval;
        let isRegistered = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô

        liff.init({ liffId }).then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            return liff.getProfile();
        }).then(profile => {
            userId = profile.userId;
            console.log("‚úÖ LINE userId:", userId);
            fetchQRCode(userId);
            startCountdown();

            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä QR ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï countdown ‡∏ó‡∏∏‡∏Å 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)
            setInterval(() => {
                if (!isRegistered) {  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                    fetchQRCode(userId);
                    resetCountdown();
                }
            }, 20000);
        }).catch(err => {
            console.error("‚ùå LIFF error:", err);
            document.getElementById("errorMessage").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
        });

        function fetchQRCode(userId) {
            if (isRegistered) {
                document.getElementById("qrCodeImage").style.display = "none";
                document.getElementById("registeredMessage").style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß"
                return;
            }

            document.getElementById("loadingMessage").style.display = "block"; // Show loading message
            fetch(SCRIPT_URL + `?userId=${encodeURIComponent(userId)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("loadingMessage").style.display = "none"; // Hide loading message
                    if (data.qrCodeUrl) {
                        document.getElementById("qrCodeImage").src = data.qrCodeUrl;
                        document.getElementById("errorMessage").innerText = "";
                    } else {
                        document.getElementById("errorMessage").innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á QR Code ‡πÑ‡∏î‡πâ";
                    }
                })
                .catch(error => {
                    console.error("Error fetching QR Code: ", error);
                    document.getElementById("loadingMessage").style.display = "none"; // Hide loading message
                    document.getElementById("errorMessage").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
                });
        }

        function startCountdown() {
            countdownSeconds = 20;  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            updateCountdown();
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                updateCountdown();
                if (countdownSeconds <= 0) {
                    countdownSeconds = 0;
                }
            }, 1000);
        }

        function resetCountdown() {
            clearInterval(countdownInterval);
            startCountdown();
        }

        function updateCountdown() {
            document.getElementById("countdown").innerText = `QR ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${countdownSeconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        function markAsRegistered() {
            isRegistered = true;
            document.getElementById("qrCodeImage").style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô QR Code
            document.getElementById("registeredMessage").style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß"
        }
    </script>
</body>

</html>


